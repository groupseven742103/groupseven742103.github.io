<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GROUP 7 ESP32 Weather Dashboard</title>

  <!-- MQTT client -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Chart.js for sparkline graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ==== PRESSURE ICON (barometer) ==== */
.pressure-icon {
  width: 40px;
  height: 56px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

.pressure-circle {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 2px solid #e5e7eb;
  position: relative;
  box-shadow: 0 0 0 2px #020617;
}

.pressure-inner-ring {
  position: absolute;
  inset: 4px;
  border-radius: 50%;
  border: 2px solid #e5e7eb;
}

/* small tick marks at left/right/top */
.pressure-tick {
  position: absolute;
  width: 6px;
  height: 2px;
  background: #e5e7eb;
  border-radius: 999px;
}
.pressure-tick.left  { left: 3px;  top: 50%; transform: translateY(-50%); }
.pressure-tick.right { right: 3px; top: 50%; transform: translateY(-50%); }
.pressure-tick.top   { top: 3px;   left: 50%; transform: translateX(-50%) rotate(90deg); }

/* needle */
.pressure-needle {
  position: absolute;
  width: 2px;
  height: 13px;
  background: #e5e7eb;
  top: 50%;
  left: 50%;
  transform-origin: 50% 100%;
  transform: translate(-50%, -100%) rotate(-35deg); /* angle of pointer */
}

.pressure-center {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #020617;
  border: 2px solid #e5e7eb;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* line under gauge */
.pressure-line {
  width: 16px;
  height: 3px;
  background: #e5e7eb;
  border-radius: 999px;
  margin-top: 4px;
}

/* little stand/legs */
.pressure-stand {
  margin-top: 3px;
  width: 14px;
  height: 14px;
  border-radius: 4px;
  border: 2px solid #e5e7eb;
  position: relative;
}

.pressure-stand::before,
.pressure-stand::after {
  content: "";
  position: absolute;
  width: 3px;
  height: 8px;
  background: #e5e7eb;
  bottom: -6px;
  border-radius: 999px;
}

.pressure-stand::before { left: 1px; }
.pressure-stand::after  { right: 1px; }

    :root {
      --bg-main: #020617;
      --bg-card: #0b1220;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent-blue: #38bdf8;
      --accent-yellow: #facc15;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-orange: #f97316;
      --accent-purple: #a855f7;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 980px;
      padding: 24px;
    }

    h1 {
      margin: 0 0 20px 0;
      text-align: left;
      font-size: 22px;
      letter-spacing: 1px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 120px;
    }

    .card-title {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0 0 8px 0;
    }

    .card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .big-value {
      font-size: 30px;
      font-weight: 700;
    }

    .unit {
      font-size: 16px;
      margin-left: 4px;
    }

    .sub-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .icon {
      font-size: 36px;
      margin-right: 4px;
    }

    .rain-icon {
      font-size: 42px;
      color: var(--accent-blue);
    }

    .wind-icon {
      font-size: 42px;
      color: var(--accent-blue);
    }

    /* Sparkline graphs */
    .sparkline-wrapper {
      margin-top: 10px;
      width: 100%;
      height: 60px;
    }

    .sparkline {
      width: 100%;
      height: 100%;
    }

    /* ====== WIND DIRECTION COMPASS ====== */
    .compass-wrapper {
      margin-top: 10px;
      height: 130px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .compass-circle {
      position: relative;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 2px solid #1f2937;
      background: radial-gradient(circle at 30% 30%, #020617, #030712);
      box-shadow: 0 0 14px rgba(0,0,0,0.7);
    }

    .compass-label {
      position: absolute;
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .compass-n { top: 4px; left: 50%; transform: translateX(-50%); }
    .compass-s { bottom: 4px; left: 50%; transform: translateX(-50%); }
    .compass-e { right: 4px; top: 50%; transform: translateY(-50%); }
    .compass-w { left: 4px; top: 50%; transform: translateY(-50%); }

    .compass-center-dot {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #111827;
      border: 2px solid #9ca3af;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 6px rgba(148,163,184,0.8);
    }

    .compass-needle {
      position: absolute;
      width: 4px;
      height: 32px;
      border-radius: 999px;
      background: var(--accent-yellow);
      top: 50%;
      left: 50%;
      transform-origin: 50% 80%;
      transform: translate(-50%, -80%) rotate(0deg);
      box-shadow: 0 0 10px rgba(250,204,21,0.7);
      transition: transform 0.35s ease;
    }

    .wind-dir-text {
      font-size: 16px;
      color: var(--text-main);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* LED buttons */
    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      min-width: 90px;
    }

    .btn-on {
      background: var(--accent-green);
      color: #022c22;
    }

    .btn-off {
      background: var(--accent-red);
      color: #450a0a;
    }

    .small-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 6px;
    }

    .badge-green { background: var(--accent-green); }
    .badge-red { background: var(--accent-red); }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .alert-icon {
      font-size: 26px;
      color: var(--accent-yellow);
    }

    .no-alerts {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Offline visual state */
    body.offline .card {
      opacity: 0.6;
    }

    body.offline .big-value,
    body.offline .sub-label {
      color: #6b7280;
    }

    body.offline #esp-status {
      color: var(--accent-red) !important;
    }

    /* Tablet: 2 columns */
    @media (max-width: 900px) {
      body {
        align-items: flex-start;
      }

      .container {
        padding: 16px;
      }

      h1 {
        text-align: center;
      }

      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* Phone: one card per screen, vertical snap scroll */
    @media (max-width: 620px) {
      body {
        display: block;
        padding: 0;
        scroll-snap-type: y mandatory;
        overflow-y: auto;
      }

      .container {
        max-width: 100%;
        padding: 16px 12px 32px;
      }

      h1 {
        font-size: 18px;
        text-align: center;
        margin-bottom: 16px;
      }

      .grid {
        display: block;
      }

      .card {
        margin-bottom: 16px;
        min-height: 30vh;
        scroll-snap-align: start;
      }

      .big-value {
        font-size: 26px;
      }

      .unit {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GROUP 7 ESP32 WEATHER DASHBOARD</h1>

    <div class="grid">
      <!-- Temperature -->
      <div class="card">
        <div>
          <p class="card-title">Temperature</p>
          <div class="card-row">
            <div>
              <div class="big-value">
                <span id="temp-value">--.-</span><span class="unit">¬∞C</span>
              </div>
              <div id="temp-level" class="sub-label">--</div>
            </div>
            <div class="icon">üå°Ô∏è</div>
          </div>
        </div>
        <div class="sub-label" id="temp-threshold">
          Threshold: &lt; 28 / 28‚Äì32 / &gt; 32 ¬∞C
        </div>

        <div class="sparkline-wrapper">
          <canvas id="temp-chart" class="sparkline"></canvas>
        </div>
      </div>

      <!-- Rain Status -->
      <div class="card">
        <div>
          <p class="card-title">Rain Status</p>
          <div class="card-row">
            <div class="rain-icon">üåßÔ∏è</div>
            <div>
              <div id="rain-status" class="big-value" style="font-size:22px;">--</div>
              <div id="rain-adc" class="sub-label">ADC: --</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Humidity -->
      <div class="card">
        <div>
          <p class="card-title">Humidity</p>
          <div class="card-row">
            <div>
              <div class="big-value">
                <span id="hum-value">--.-</span><span class="unit">%</span>
              </div>
              <div id="hum-level" class="sub-label">--</div>
            </div>
            <div class="icon">üíß</div>
          </div>
        </div>

        <div class="sparkline-wrapper">
          <canvas id="hum-chart" class="sparkline"></canvas>
        </div>
      </div>

      <!-- LED Indicator control -->
      <div class="card">
        <div>
          <p class="card-title">LED Indicator</p>
          <div class="big-value" id="led-state" style="font-size:22px;">OFF</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-on" onclick="setIndicator(true)">Turn ON</button>
          <button class="btn btn-off" onclick="setIndicator(false)">Turn OFF</button>
        </div>
      </div>

      <!-- Wind (speed only) -->
      <div class="card">
        <div>
          <p class="card-title">Wind</p>
          <div class="card-row">
            <div>
              <div class="big-value">
                <span id="wind-speed">--.-</span><span class="unit">mph</span>
              </div>
              <div id="wind-level" class="sub-label">--</div>
            </div>
            <div class="wind-icon">üå¨Ô∏è</div>
          </div>
        </div>

        <div class="sparkline-wrapper">
          <canvas id="wind-chart" class="sparkline"></canvas>
        </div>
      </div>

      <!-- Wind Direction (COMPASS) -->
      <div class="card">
        <div>
          <p class="card-title">Wind Direction</p>
          <div class="compass-wrapper">
            <div class="compass-circle">
              <div class="compass-label compass-n">N</div>
              <div class="compass-label compass-e">E</div>
              <div class="compass-label compass-s">S</div>
              <div class="compass-label compass-w">W</div>
              <div id="compass-needle" class="compass-needle"></div>
              <div class="compass-center-dot"></div>
            </div>
            <div id="wind-dir-text" class="wind-dir-text">--</div>
          </div>
        </div>
      </div>

            <!-- Pressure -->
<div class="card">
  <div>
    <p class="card-title">Pressure</p>
    <div class="card-row">
      <div class="big-value" style="font-size:24px;">
        <span id="pres-value">----.-</span><span class="unit">hPa</span>
      </div>
      <div class="pressure-icon">
        <div class="pressure-circle">
          <div class="pressure-inner-ring"></div>
          <div class="pressure-tick left"></div>
          <div class="pressure-tick right"></div>
          <div class="pressure-tick top"></div>
          <div class="pressure-needle"></div>
          <div class="pressure-center"></div>
        </div>
        <div class="pressure-line"></div>
        <div class="pressure-stand"></div>
      </div>
    </div>
  </div>

  <div class="sparkline-wrapper">
    <canvas id="pres-chart" class="sparkline"></canvas>
  </div>
</div>



      <!-- Lux / Light Level -->
      <div class="card">
        <div>
          <p class="card-title">Light Level</p>
          <div class="card-row">
            <div>
              <div class="big-value">
                <span id="lux-value">----</span><span class="unit"> lx</span>
              </div>
              <div id="lux-level" class="sub-label">--</div>
            </div>
            <div class="icon">üí°</div>
          </div>
        </div>
        <div class="sub-label" id="lux-note">BH1750 ambient light</div>

        <div class="sparkline-wrapper">
          <canvas id="lux-chart" class="sparkline"></canvas>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card">
        <div>
          <p class="card-title">Alerts</p>
          <div id="alert-box">
            <div class="no-alerts">No active alerts</div>
          </div>
        </div>
      </div>

      <!-- ESP32 / MQTT Status -->
      <div class="card">
        <div>
          <p class="card-title">ESP32 Status</p>
          <div class="big-value" id="esp-status" style="font-size:20px; color: var(--accent-red);">
            OFFLINE
          </div>
        </div>
        <div>
          <div class="small-text">
            <span class="badge-dot badge-green"></span>Wi-Fi:
            <span id="wifi-status">Connecting‚Ä¶</span>
          </div>
          <div class="small-text" style="margin-top:4px;">
            <span class="badge-dot badge-green"></span>MQTT:
            <span id="mqtt-status">Connecting‚Ä¶</span>
          </div>
          <div class="small-text" style="margin-top:6px;">
            Last update:
            <span id="last-update">None</span>
          </div>
        </div>
      </div>

      <!-- Device info / metadata -->
      <div class="card">
        <div>
          <p class="card-title">Device Info</p>
          <div class="sub-label">Dashboard for GROUP 7 ESP32 Weather Station.</div>
          <div class="sub-label"><strong>Device:</strong> ESP32 Weather Node #1</div>
          <div class="sub-label"><strong>Firmware:</strong> v1.0.0 (demo)</div>
          <div class="sub-label"><strong>Location:</strong> Outdoor</div>
        </div>
        <div class="sub-label" style="margin-top:8px;">
          Designed for Temperature, Humidity, Pressure, Rain, Wind Speed &amp; Direction, and Light Level.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== HiveMQ Cloud WebSocket settings =====
    const host = "wss://2a5578d6282f481d8c6bf51d434926fa.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "GROUPSEVEN",
      password: "October103",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 2000
    };

    // Topics (must match ESP32 code)
    const topicTemp       = "robota/esp32/temperature";
    const topicHum        = "robota/esp32/humidity";
    const topicLevel      = "robota/esp32/temp_level";
    const topicIndCmd     = "robota/esp32/indicator/cmd";
    const topicIndState   = "robota/esp32/indicator/state";
    const topicPress      = "robota/esp32/pressure";
    const topicRainStatus = "robota/esp32/rain_status";
    const topicRainAdc    = "robota/esp32/rain_adc";
    const topicWindMph    = "robota/esp32/wind_mph";
    const topicWindDir    = "robota/esp32/wind_dir";
    const topicLux        = "robota/esp32/lux";

    // DOM elements
    const tempEl        = document.getElementById("temp-value");
    const tempLevelEl   = document.getElementById("temp-level");
    const tempThreshEl  = document.getElementById("temp-threshold");
    const humEl         = document.getElementById("hum-value");
    const humLevelEl    = document.getElementById("hum-level");
    const presEl        = document.getElementById("pres-value");
    const rainStatusEl  = document.getElementById("rain-status");
    const rainAdcEl     = document.getElementById("rain-adc");
    const windSpeedEl   = document.getElementById("wind-speed");
    const windLevelEl   = document.getElementById("wind-level");
    const windDirTextEl = document.getElementById("wind-dir-text");
    const compassNeedleEl = document.getElementById("compass-needle");
    const alertBoxEl    = document.getElementById("alert-box");
    const espStatusEl   = document.getElementById("esp-status");
    const wifiStatusEl  = document.getElementById("wifi-status");
    const mqttStatusEl  = document.getElementById("mqtt-status");
    const lastUpdateEl  = document.getElementById("last-update");
    const ledStateEl    = document.getElementById("led-state");
    const luxEl         = document.getElementById("lux-value");
    const luxLevelEl    = document.getElementById("lux-level");

    // Sparkline canvases
    const tempChartCtx = document.getElementById("temp-chart").getContext("2d");
    const humChartCtx  = document.getElementById("hum-chart").getContext("2d");
    const windChartCtx = document.getElementById("wind-chart").getContext("2d");
    const luxChartCtx  = document.getElementById("lux-chart").getContext("2d");
    const presChartCtx = document.getElementById("pres-chart").getContext("2d");

    // Current sensor values (for alerts)
    let currentTemp       = null;
    let currentHum        = null;
    let currentPress      = null;
    let currentWind       = null;
    let currentRainStatus = null;
    let currentRainAdc    = null;
    let currentLux        = null;

    function setLastUpdate() {
      const now = new Date();
      lastUpdateEl.textContent = now.toLocaleTimeString();
    }

    function setOnlineState(isOnline) {
      if (isOnline) {
        document.body.classList.remove("offline");
      } else {
        document.body.classList.add("offline");

        tempEl.textContent = "--.-";
        humEl.textContent = "--.-";
        presEl.textContent = "----.-";
        windSpeedEl.textContent = "--.-";
        luxEl.textContent = "----";

        tempLevelEl.textContent = "--";
        humLevelEl.textContent = "--";
        windLevelEl.textContent = "--";
        windDirTextEl.textContent = "--";
        if (compassNeedleEl) {
          compassNeedleEl.style.transform =
            "translate(-50%, -80%) rotate(0deg)";
        }
        rainStatusEl.textContent = "--";
        rainAdcEl.textContent = "ADC: --";
        luxLevelEl.textContent = "--";

        alertBoxEl.innerHTML = '<div class="no-alerts">Device offline</div>';
      }
    }

    function setMQTTStatus(text, ok) {
      mqttStatusEl.textContent = text;
      espStatusEl.textContent  = ok ? "ONLINE" : "OFFLINE";
      espStatusEl.style.color  = ok ? "#22c55e" : "#ef4444";
      setOnlineState(ok);
    }

    // ===== Color-state helpers =====
    function updateTempLevel(level) {
      let txt = level;
      let color = "#9ca3af";
      let thresholdText = "Threshold: < 28 / 28‚Äì32 / > 32 ¬∞C";

      if (level === "COOL") {
        color = "#38bdf8";
        txt   = "COOL";
        thresholdText = "Threshold: < 28 ¬∞C";
      } else if (level === "WARM") {
        color = "#eab308";
        txt   = "WARM";
        thresholdText = "Threshold: 28 ‚Äì 32 ¬∞C";
      } else if (level === "HOT") {
        color = "#ef4444";
        txt   = "HOT";
        thresholdText = "Threshold: > 32 ¬∞C";
      }

      tempLevelEl.textContent = txt;
      tempLevelEl.style.color = color;
      tempThreshEl.textContent = thresholdText;
    }

    function updateHumLevel(h) {
      if (h == null || isNaN(h)) {
        humLevelEl.textContent = "--";
        humLevelEl.style.color = "#9ca3af";
        return;
      }

      let text = "";
      let color = "#9ca3af";

      if (h < 40) {
        text = "DRY";
        color = "#eab308";
      } else if (h <= 60) {
        text = "COMFY";
        color = "#22c55e";
      } else {
        text = "HUMID";
        color = "#38bdf8";
      }

      humLevelEl.textContent = text;
      humLevelEl.style.color = color;
    }

    function updateRain(status, adc) {
      let displayStatus = "--";
      if (status) {
        displayStatus = status.replace("_", " ");
      }
      rainStatusEl.textContent = displayStatus;
      currentRainStatus = displayStatus;

      if (adc !== undefined) {
        rainAdcEl.textContent = "ADC: " + adc;
        currentRainAdc = adc;
      }
    }

    function updateWindSpeed(mphStr) {
      const speed = parseFloat(mphStr);
      if (isNaN(speed)) {
        currentWind = null;
        windSpeedEl.textContent = "--.-";
        windLevelEl.textContent = "--";
        windLevelEl.style.color = "#9ca3af";
        addPoint(windChart, null);
        return;
      }

      currentWind = speed;
      windSpeedEl.textContent = speed.toFixed(1);

      let levelText = "";
      let color = "#9ca3af";

      if (speed < 10) {
        levelText = "NORMAL";
        color = "#22c55e";
      } else if (speed < 20) {
        levelText = "MODERATE";
        color = "#eab308";
      } else {
        levelText = "STRONG";
        color = "#ef4444";
      }

      windLevelEl.textContent = levelText;
      windLevelEl.style.color = color;

      addPoint(windChart, speed);
    }

    function updateWindDirection(code) {
      if (!code) {
        windDirTextEl.textContent = "--";
        if (compassNeedleEl) {
          compassNeedleEl.style.transform =
            "translate(-50%, -80%) rotate(0deg)";
        }
        return;
      }

      const c = code.trim().toUpperCase();
      let label = c;
      let angle = 0;

      if (c === "N") { label = "NORTH"; angle =   0; }
      else if (c === "E") { label = "EAST";  angle =  90; }
      else if (c === "S") { label = "SOUTH"; angle = 180; }
      else if (c === "W") { label = "WEST";  angle = 270; }

      windDirTextEl.textContent = label;
      if (compassNeedleEl) {
        compassNeedleEl.style.transform =
          `translate(-50%, -80%) rotate(${angle}deg)`;
      }
    }

    function updateLux(luxStr) {
      const lux = parseFloat(luxStr);
      if (isNaN(lux)) {
        currentLux = null;
        luxEl.textContent = "--";
        luxLevelEl.textContent = "--";
        luxLevelEl.style.color = "#9ca3af";
        addPoint(luxChart, null);
        return;
      }

      currentLux = lux;
      luxEl.textContent = lux.toFixed(0);

      let levelText = "";
      let color = "#9ca3af";

      if (lux < 100) {
        levelText = "DARK";
        color = "#9ca3af";
      } else if (lux < 1000) {
        levelText = "INDOOR";
        color = "#22c55e";
      } else if (lux < 10000) {
        levelText = "CLOUDY";
        color = "#eab308";
      } else {
        levelText = "SUNNY";
        color = "#f97316";
      }

      luxLevelEl.textContent = levelText;
      luxLevelEl.style.color = color;

      addPoint(luxChart, lux);
    }

    function setIndicator(on) {
      if (!client.connected) return;
      const msg = on ? "ON" : "OFF";
      client.publish(topicIndCmd, msg);
    }
    window.setIndicator = setIndicator;

    function updateAlerts() {
      const alerts = [];

      if (currentTemp !== null && currentTemp > 32) {
        alerts.push("High temperature alert");
      }

      if (currentPress !== null && currentPress < 1000) {
        alerts.push("Low pressure alert (possible bad weather)");
      }

      if (currentWind !== null && currentWind > 20) {
        alerts.push("High wind alert");
      }

      if (currentRainStatus) {
        const s = currentRainStatus.toUpperCase();
        if (!s.includes("NO") && s.includes("RAIN")) {
          alerts.push("Heavy rain alert");
        }
      }

      alertBoxEl.innerHTML = "";
      if (alerts.length === 0) {
        const div = document.createElement("div");
        div.className = "no-alerts";
        div.textContent = "No active alerts";
        alertBoxEl.appendChild(div);
      } else {
        alerts.forEach(msg => {
          const div = document.createElement("div");
          div.className = "alert-item";
          div.innerHTML = `<span class="alert-icon">‚ö†Ô∏è</span><span>${msg}</span>`;
          alertBoxEl.appendChild(div);
        });
      }
    }

    // ===== Sparkline charts (Chart.js) =====
    const maxPoints = 30;

    function createSparkline(ctx, color, label, unit) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            data: [],
            label: label,
            borderColor: color,
            backgroundColor: "rgba(0,0,0,0)",
            tension: 0.35,
            pointRadius: 1.5,
            pointHitRadius: 8,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  const v = context.parsed.y;
                  if (v == null || isNaN(v)) {
                    return `${label}: --`;
                  }
                  const val = (unit.trim() === "lx" || unit.trim() === "hPa")
                    ? v.toFixed(0)
                    : v.toFixed(1);
                  return `${label}: ${val}${unit}`;
                }
              }
            }
          },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          interaction: {
            intersect: false,
            mode: "index"
          }
        }
      });
    }

    const tempChart = createSparkline(tempChartCtx, "#f97316", "Temperature", " ¬∞C");
    const humChart  = createSparkline(humChartCtx,  "#38bdf8", "Humidity", " %");
    const windChart = createSparkline(windChartCtx, "#22c55e", "Wind", " mph");
    const luxChart  = createSparkline(luxChartCtx,  "#facc15", "Light", " lx");
    const presChart = createSparkline(presChartCtx, "#a855f7", "Pressure", " hPa");

    function addPoint(chart, value) {
      if (!chart) return;
      const data = chart.data.datasets[0].data;
      const labels = chart.data.labels;

      data.push(value);
      labels.push("");

      if (data.length > maxPoints) {
        data.shift();
        labels.shift();
      }

      chart.update();
    }

    // ===== MQTT client =====
    const client = mqtt.connect(host, options);

    client.on("connect", () => {
      wifiStatusEl.textContent = "Connected";
      setMQTTStatus("Connected", true);

      client.subscribe([
        topicTemp,
        topicHum,
        topicLevel,
        topicIndState,
        topicPress,
        topicRainStatus,
        topicRainAdc,
        topicWindMph,
        topicWindDir,
        topicLux
      ], (err) => {
        if (err) {
          setMQTTStatus("Subscribe error", false);
          console.error("Subscribe error:", err);
        }
      });
    });

    client.on("reconnect", () => {
      setMQTTStatus("Reconnecting‚Ä¶", false);
    });

    client.on("error", (err) => {
      console.error("MQTT error:", err);
      setMQTTStatus("Error", false);
    });

    let lastRainAdcValue = "--";

    client.on("message", (topic, message) => {
      const payload = message.toString();
      console.log("Message:", topic, payload);

      if (topic === topicTemp) {
        const tVal = parseFloat(payload);
        if (!isNaN(tVal)) {
          currentTemp = tVal;
          tempEl.textContent = tVal.toFixed(1);
          addPoint(tempChart, tVal);
        } else {
          currentTemp = null;
          tempEl.textContent = payload;
          addPoint(tempChart, null);
        }
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicHum) {
        const hVal = parseFloat(payload);
        if (!isNaN(hVal)) {
          currentHum = hVal;
          humEl.textContent = hVal.toFixed(1);
          updateHumLevel(hVal);
          addPoint(humChart, hVal);
        } else {
          currentHum = null;
          humEl.textContent = payload;
          updateHumLevel(null);
          addPoint(humChart, null);
        }
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicLevel) {
        updateTempLevel(payload.trim());
        setLastUpdate();

      } else if (topic === topicIndState) {
        ledStateEl.textContent = payload.toUpperCase();
        setLastUpdate();

      } else if (topic === topicPress) {
        const p = parseFloat(payload);
        if (!isNaN(p)) {
          currentPress = p;
          presEl.textContent = p.toFixed(1);
          addPoint(presChart, p);
        } else {
          currentPress = null;
          presEl.textContent = payload;
          addPoint(presChart, null);
        }
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicRainStatus) {
        updateRain(payload, lastRainAdcValue);
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicRainAdc) {
        const adc = parseInt(payload, 10);
        lastRainAdcValue = isNaN(adc) ? payload : adc;
        updateRain(rainStatusEl.textContent.replace(" ", "_"), lastRainAdcValue);
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicWindMph) {
        updateWindSpeed(payload);
        setLastUpdate();
        updateAlerts();

      } else if (topic === topicWindDir) {
        updateWindDirection(payload);
        setLastUpdate();

      } else if (topic === topicLux) {
        updateLux(payload);
        setLastUpdate();
        updateAlerts();
      }
    });
  </script>
</body>
</html>
